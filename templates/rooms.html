{% extends "templates/base.html" %}
{% block content %}

<section class="section">
  <div class="section__container">
    <div class="btn-list">
      {% for voteValue in voteValues %}
      <button class="btn btn--vote" onclick="clickBtn({{voteValue}})">{{voteValue}}</button>
      {% endfor %}
    </div>

    <div class="vote-result">
      <div class="section__title">Result</div>
      <div class="result"></div>
      <div class="vote-result__svg">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" width="64" height="64">
          <path
              style="text-indent:0;text-align:start;line-height:normal;text-transform:none;block-progression:tb;-inkscape-font-specification:Bitstream Vera Sans"
              d="M 16 4 C 11.670817 4 8 7.0555434 8 11 L 8 13 L 8 14 L 9 14 L 13 14 L 14 14 L 14 13 L 14 11 C 14 10.852628 14.09002 10.637876 14.4375 10.40625 C 14.784979 10.174624 15.351544 10 16 10 C 16.652077 10 17.217134 10.177464 17.5625 10.40625 C 17.907866 10.635036 18 10.837135 18 11 C 18 11.579322 17.810652 11.978859 17.4375 12.4375 C 17.064348 12.896141 16.482053 13.366182 15.84375 13.90625 C 14.567145 14.986386 13 16.495868 13 19 L 13 20 L 14 20 L 18 20 L 19 20 L 19 19 C 19 18.659727 19.12404 18.420769 19.5 18.03125 C 19.87596 17.641731 20.496404 17.17993 21.15625 16.625 C 22.475941 15.515139 24 13.816454 24 11 C 24 7.0886458 20.336253 4 16 4 z M 16 6 C 19.395747 6 22 8.3653542 22 11 C 22 13.144546 21.024059 14.101111 19.84375 15.09375 C 19.253596 15.59007 18.62404 16.074457 18.0625 16.65625 C 17.715454 17.015813 17.446588 17.484151 17.25 18 L 15.3125 18 C 15.626723 16.98873 16.234406 16.217473 17.15625 15.4375 C 17.767947 14.919943 18.435652 14.381141 19 13.6875 C 19.564348 12.993859 20 12.081178 20 11 C 20 10.039865 19.427884 9.2404641 18.6875 8.75 C 17.947116 8.2595359 17.004923 8 16 8 C 14.991456 8 14.050771 8.257876 13.3125 8.75 C 12.574229 9.242124 12 10.042372 12 11 L 12 12 L 10 12 L 10 11 C 10 8.3164566 12.597183 6 16 6 z M 13 22 L 13 23 L 13 27 L 13 28 L 14 28 L 18 28 L 19 28 L 19 27 L 19 23 L 19 22 L 18 22 L 14 22 L 13 22 z M 15 24 L 17 24 L 17 26 L 15 26 L 15 24 z"
              color="#000" overflow="visible" font-family="Bitstream Vera Sans"/>
        </svg>
      </div>
      <button class="btn" id="btnStart">start</button>
    </div>

  </div>
</section>

<section class="section">
  <div class="section__container">
<!--
    <p>Hello! We have <span class="userCount"></span>'s user!</p>
-->

    <div class="users-list"></div>

  </div>
</section>

<div id="templateUser" class="users-list__item m-hide">
  <div class="users-list__item__name"></div>
  <div class="users-list__item__result"></div>
</div>

{% endblock %}

{% block script%}
<script src="/socket.io/socket.io.js"></script>
<script>
  "use strict";

  var user = localStorage.getItem('user') || getUser();

  var socket = io(location.pathname.replace('/rooms', '')),
      btnStart = document.getElementById('btnStart'),
      btnList = document.getElementsByClassName('btn-list')[0],
      result = document.getElementsByClassName('result')[0];

  btnList.classList.add('btn-list--disable');

  socket.emit('connect user', user);

  socket.on('start', function (msg) {
    console.log('Stat');
    result.textContent = '';
    btnList.classList.remove('btn-list--disable');
  });

  socket.on('finish', function (msg) {
    console.log('Stat');
    /* btnList.style.display = 'none';*/
    result.textContent = 'Result = ' + msg;
  });

  socket.on('add user', function (msg) {
    //document.getElementsByClassName('userCount')[0].textContent = msg;
  });

  socket.on('update:users', function (users) {
    var userList = document.getElementsByClassName('users-list')[0];
    userList.innerHTML = '';

    var userCount = 0;
    users.forEach(function (user) {
      var div = document.getElementById('templateUser').cloneNode(true);
      div.removeAttribute('id');
      div.classList.remove('m-hide');

      var name = div.getElementsByClassName('users-list__item__name')[0];
      name.innerHTML = user.name;

      var result = div.getElementsByClassName('users-list__item__result')[0];
      if(user.status){
        result.classList.add('users-list__item__result--' + user.status);
        console.log('status', user.status);
        result.innerHTML = (user.status && user.status != 'done'  ? user.status : '') + (user.result ?  user.result : '');
      } else {
        result.classList.add('m-hide');
      }

      userList.appendChild(div);
    });

    //document.getElementsByClassName('userCount')[0].textContent = userCount;

  });

  btnStart.onclick = function () {
    socket.emit('start');
  };

  function clickBtn(data) {
    socket.emit('vote', data);
  }

  function getUser() {
    var user = prompt('Name user');
    localStorage.setItem('user', user);
    return user;
  }

</script>

{% endblock %}
